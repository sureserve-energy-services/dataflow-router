name: Build, Test, Analyze and Publish

on:
  push:
    branches:
      - dev

env:
  # Static values
  VERSION: 0.2.53
  SUFFIX: dev
  BUILD_CONFIGURATION: Debug

  # These map to your ENVx_ variables (can also move to secrets if sensitive)
  ENV0_ENVIRONMENTTYPE: ${{ vars.ENV0_ENVIRONMENTTYPE }}
  ENV0_INPUTPATH: ${{ vars.ENV0_INPUTPATH }}
  ENV0_FLAG: ${{ vars.ENV0_FLAG }}
  ENV0_OUTPUTTYPE: ${{ vars.ENV0_OUTPUTTYPE }}
  ENV0_OUTPUTCOMMAND: ${{ vars.ENV0_OUTPUTCOMMAND }}
  ENV0_OUTPUTPATH: ${{ vars.ENV0_OUTPUTPATH }}
  ENV0_DESTINATIONUSERNAME: ${{ vars.ENV0_DESTINATIONUSERNAME }}
  ENV0_DESTINATIONPASSWORD: ${{ secrets.ENV0_DESTINATIONPASSWORD }}
  ENV0_FILEEXT0: ${{ vars.ENV0_FILEEXT0 }}

  ENV1_ENVIRONMENTTYPE: ${{ vars.ENV1_ENVIRONMENTTYPE }}
  ENV1_INPUTPATH: ${{ vars.ENV1_INPUTPATH }}
  ENV1_FLAG: ${{ vars.ENV1_FLAG }}
  ENV1_OUTPUTTYPE: ${{ vars.ENV1_OUTPUTTYPE }}
  ENV1_OUTPUTCOMMAND: ${{ vars.ENV1_OUTPUTCOMMAND }}
  ENV1_OUTPUTPATH: ${{ vars.ENV1_OUTPUTPATH }}
  ENV1_DESTINATIONUSERNAME: ${{ vars.ENV1_DESTINATIONUSERNAME }}
  ENV1_DESTINATIONPASSWORD: ${{ secrets.ENV1_DESTINATIONPASSWORD }}
  ENV1_FILEEXT0: ${{ vars.ENV1_FILEEXT0 }}

  ENV2_ENVIRONMENTTYPE: ${{ vars.ENV2_ENVIRONMENTTYPE }}
  ENV2_INPUTPATH: ${{ vars.ENV2_INPUTPATH }}
  ENV2_FLAG: ${{ vars.ENV2_FLAG }}
  ENV2_OUTPUTTYPE: ${{ vars.ENV2_OUTPUTTYPE }}
  ENV2_OUTPUTCOMMAND: ${{ vars.ENV2_OUTPUTCOMMAND }}
  ENV2_OUTPUTPATH: ${{ vars.ENV2_OUTPUTPATH }}
  ENV2_DESTINATIONUSERNAME: ${{ vars.ENV2_DESTINATIONUSERNAME }}
  ENV2_DESTINATIONPASSWORD: ${{ secrets.ENV2_DESTINATIONPASSWORD }}
  ENV2_FILEEXT0: ${{ vars.ENV2_FILEEXT0 }}

  # Logging config (from your MHHSTest group originally)
  LOGGING_INGEST_URL: ${{ vars.LOGGING_INGEST_URL }}
  LOGGING_API_KEY: ${{ secrets.LOGGING_API_KEY }}

jobs:
  build-and-test:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
          include-prerelease: false

      # SonarCloud Prepare
      - name: SonarCloud - Prepare
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectKey: providor_mhhs-request-service
          organization: providor
          scannerMode: dotnet
          args: >
            -Dsonar.scanner.scanAll=false
            -Dsonar.cs.opencover.reportsPaths=${{ runner.temp }}/**/coverage.opencover.xml
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Restore
        run: |
          dotnet restore "$(pwd)/**/*.csproj" \
            --configfile nuget.dev.config

      - name: Build
        run: |
          dotnet build "$(pwd)/**/*.csproj" \
            --configuration $BUILD_CONFIGURATION \
            --no-restore

      - name: Test
        run: |
          dotnet test "$(pwd)/**/*.csproj" \
            --configuration $BUILD_CONFIGURATION \
            --no-build \
            /p:CollectCoverage=true \
            /p:CoverletOutputFormat=opencover \
            /p:CoverletOutput=${{ runner.temp }}/TestResults/coverage \
            /p:Exclude="[*.UnitTests]*" \
            /p:Exclude="[*.IntegrationTests]*"

      # SonarCloud Analyze + Publish
      - name: SonarCloud - Analyze
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectKey: providor_mhhs-request-service
          organization: providor
          scannerMode: 'cli'
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: SonarCloud - Quality Gate
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectKey: providor_mhhs-request-service
          organization: providor
          scannerMode: 'cli'
          args: >
            -Dsonar.qualitygate.wait=true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # GitHub Advanced Security dependency scanning equivalent:
      # If you have GHAS, you can enable Dependabot / CodeQL separately.
      - name: Dependency Review (GHAS)
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4

  build-image-and-push:
    runs-on: ubuntu-24.04
    needs: build-and-test
    continue-on-error: true

    env:
      IMAGE_NAME: providor/mhhs-request-service
      IMAGE_TAG: ${{ env.VERSION }}-${{ env.SUFFIX }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GitLab Container Registry
        # Replace these with your real GitLab registry URL and credentials
        run: |
          echo "${{ secrets.GITLAB_REGISTRY_PASSWORD }}" | docker login ${{ vars.GITLAB_REGISTRY_URL }} \
            -u "${{ secrets.GITLAB_REGISTRY_USERNAME }}" --password-stdin

      - name: Build Docker image
        run: |
          docker build \
            --build-arg ENV0_ENVIRONMENTTYPE="${ENV0_ENVIRONMENTTYPE}" \
            --build-arg ENV0_INPUTPATH="${ENV0_INPUTPATH}" \
            --build-arg ENV0_FLAG="${ENV0_FLAG}" \
            --build-arg ENV0_OUTPUTTYPE="${ENV0_OUTPUTTYPE}" \
            --build-arg ENV0_OUTPUTCOMMAND="${ENV0_OUTPUTCOMMAND}" \
            --build-arg ENV0_OUTPUTPATH="${ENV0_OUTPUTPATH}" \
            --build-arg ENV0_DESTINATIONUSERNAME="${ENV0_DESTINATIONUSERNAME}" \
            --build-arg ENV0_DESTINATIONPASSWORD="${ENV0_DESTINATIONPASSWORD}" \
            --build-arg ENV0_FILEEXT0="${ENV0_FILEEXT0}" \
            --build-arg ENV1_ENVIRONMENTTYPE="${ENV1_ENVIRONMENTTYPE}" \
            --build-arg ENV1_INPUTPATH="${ENV1_INPUTPATH}" \
            --build-arg ENV1_FLAG="${ENV1_FLAG}" \
            --build-arg ENV1_OUTPUTTYPE="${ENV1_OUTPUTTYPE}" \
            --build-arg ENV1_OUTPUTCOMMAND="${ENV1_OUTPUTCOMMAND}" \
            --build-arg ENV1_OUTPUTPATH="${ENV1_OUTPUTPATH}" \
            --build-arg ENV1_DESTINATIONUSERNAME="${ENV1_DESTINATIONUSERNAME}" \
            --build-arg ENV1_DESTINATIONPASSWORD="${ENV1_DESTINATIONPASSWORD}" \
            --build-arg ENV1_FILEEXT0="${ENV1_FILEEXT0}" \
            --build-arg ENV2_ENVIRONMENTTYPE="${ENV2_ENVIRONMENTTYPE}" \
            --build-arg ENV2_INPUTPATH="${ENV2_INPUTPATH}" \
            --build-arg ENV2_FLAG="${ENV2_FLAG}" \
            --build-arg ENV2_OUTPUTTYPE="${ENV2_OUTPUTTYPE}" \
            --build-arg ENV2_OUTPUTCOMMAND="${ENV2_OUTPUTCOMMAND}" \
            --build-arg ENV2_OUTPUTPATH="${ENV2_OUTPUTPATH}" \
            --build-arg ENV2_DESTINATIONUSERNAME="${ENV2_DESTINATIONUSERNAME}" \
            --build-arg ENV2_DESTINATIONPASSWORD="${ENV2_DESTINATIONPASSWORD}" \
            --build-arg ENV2_FILEEXT0="${ENV2_FILEEXT0}" \
            --build-arg LOGGING_INGEST_URL="${LOGGING_INGEST_URL}" \
            --build-arg LOGGING_API_KEY="${LOGGING_API_KEY}" \
            -t ${{ vars.GITLAB_REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .

      - name: Push Docker image
        run: |
          docker push ${{ vars.GITLAB_REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
